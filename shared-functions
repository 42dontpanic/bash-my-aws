#!/bin/bash

if [[ -z ${BMA_OUTPUT} ]]; then
  BMA_OUTPUT="text"
fi

if [[ -z ${INSTANCE_OUTPUT} ]]; then
  INSTANCE_OUTPUT="[
    InstanceId,
    State.Name,
    InstanceType,
    PrivateIpAddress,
    PublicIpAddress,
    join(\` \`, [Tags[?Key==\`Name\`].Value][]),
    join(\` \`, [Tags[?Key==\`contact\`].Value][]),
    LaunchTime
  ]"
fi

if [[ -z ${VOLUME_OUTPUT} ]]; then
  VOLUME_OUTPUT='[VolumeId, Size, VolumeType, State, CreateTime]'
fi

if [[ -z ${INSTANCE_OUTPUT} ]]; then
  INSTANCE_PROFILE_OUTPUT="[
    Profile
  ]"
fi

if [[ -z ${ELB_OUTPUT} ]]; then
  ELB_OUTPUT="[
    LoadBalancerName
  ]"
fi

if [[ -z ${ASG_OUTPUT} ]]; then
  ASG_OUTPUT="[
    AutoScalingGroupName
  ]"
fi

__bma_read_inputs() {
  # echo "${FUNCNAME}: \$@='${@}'" >&2
  if [[ -t 0 ]]; then
    # STDIN is a terminal
    echo $@
  else
    __bma_read_stdin | __bma_switch_with $@
  fi
}

__bma_read_stdin() {
  [[ -t 0 ]] ||
    cat /dev/stdin     |
    awk '{ print $1 }' |
    tr '\n' ' '        |
    sed 's/\ $//'
}

__bma_switch_with() {
  # USAGE:  echo one two three | __bma_apply_switch --the-switch
  # OUTPUT: --the-switch one --the-switch two --the-switch three
  [[ -t 0 ]] && return 0
  if [[ -z $1 ]]; then
    cat /dev/stdin
    return 0
  fi

  for stdin in $(cat /dev/stdin); do
    for switch in $@; do
      echo -n "$switch $stdin "
    done
  done
  echo
}

__bma_read_switch() {
  [[ -t 0 ]] && return 0
  local found=false

  for i in $(cat /dev/stdin); do
    if ${found}; then
      echo $i
      return 0
    fi

    [[ "${i}" == "--$1" ]] && local found=true
  done
}

__bma_clean_query() {
  __bma_read_inputs "$@" | tr -d '[:blank:]\n'
}

# vim: ft=sh
